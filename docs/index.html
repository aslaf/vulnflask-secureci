<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VulnFlask-SecureCI — Security Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
  :root {
    --ok: #16a34a;      /* green 600 */
    --warn: #f59e0b;    /* amber 500 */
    --fail: #ef4444;    /* red 500 */
    --muted: #6b7280;   /* gray 500 */
    --border: #e5e7eb;  /* gray 200 */
  }
  body { font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 32px; color: #111; }
  h1 { font-size: 24px; margin-bottom: 4px; }
  h2 { font-size: 18px; margin: 0 0 8px 0; }
  .muted { color: var(--muted); font-size: 14px; }
  table { border-collapse: collapse; width: 100%; margin-top: 16px; }
  th, td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }
  th { background: #f9fafb; }
  .ok { color: var(--ok); }
  .warn { color: var(--warn); }
  .na { color: var(--muted); }
  .footer { margin-top: 24px; font-size: 13px; color: var(--muted); }
  .links a { margin-right: 12px; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    margin-top: 20px;
    align-items: start;
  }
  .card {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
  }

  /* Gauge center label */
  .gauge-wrap {
    position: relative;
    height: 220px;
  }
  .gauge-label {
    position: absolute;
    left: 0; right: 0;
    bottom: 30px;
    text-align: center;
    font-size: 28px;
    font-weight: 700;
  }
  .grade {
    position: absolute;
    left: 0; right: 0;
    bottom: 8px;
    text-align: center;
    font-size: 13px;
    color: var(--muted);
  }
</style>
</head>
<body>
  <h1>VulnFlask-SecureCI — Security Dashboard</h1>
  <div class="muted" id="generatedStamp">Generated: —</div>

  <!-- Top visuals -->
  <div class="grid">
    <div class="card">
      <h2>Posture Score</h2>
      <div class="gauge-wrap">
        <canvas id="gaugeCanvas" height="220"></canvas>
        <div id="gaugeScore" class="gauge-label">—</div>
        <div id="gaugeGrade" class="grade">Grade: —</div>
      </div>
    </div>

    <div class="card">
      <h2>Finding Trends</h2>
      <canvas id="trendCanvas" height="220"></canvas>
      <div class="muted" style="margin-top:8px" id="trendNote">
        Showing last runs for Critical/High/Medium/Low. If nothing appears, run analytics to generate insights history.
      </div>
    </div>
  </div>

  <!-- Executive charts -->
  <div class="grid" style="margin-top: 30px;">
    <div class="card">
      <h2>Historical Posture</h2>
      <canvas id="historyChart" height="200"></canvas>
    </div>
    <div class="card">
      <h2>Risk Category Breakdown</h2>
      <canvas id="riskChart" height="200"></canvas>
    </div>
  </div>

  <!-- Summary table -->
  <table>
    <thead>
      <tr><th>Tool</th><th>Status</th><th>Findings</th></tr>
    </thead>
    <tbody>
      <tr><td>Bandit (SAST)</td><td>N/A</td><td>0</td></tr>
      <tr><td>Semgrep (Code)</td><td>N/A</td><td>0</td></tr>
      <tr><td>pip-audit (SCA)</td><td>N/A</td><td>0</td></tr>
      <tr><td>Trivy/Container</td><td>Present</td><td>62</td></tr>
      <tr><td>OWASP ZAP (DAST)</td><td>N/A</td><td>0</td></tr>
    </tbody>
  </table>

  <div class="footer">
    Missing = N/A (scan not run). This page is updated by CI (Day 12–17).
  </div>
  <div class="links" style="margin-top:12px;">
    <a href="./security-report.md" target="_blank">security-report.md</a>
    <a href="./insights.json" target="_blank">insights.json</a>
    <a href="./bandit-report.json" target="_blank">bandit-report.json</a>
    <a href="./semgrep-report.json" target="_blank">semgrep-report.json</a>
    <a href="./pip-audit-report.json" target="_blank">pip-audit-report.json</a>
    <a href="./trivy-report.json" target="_blank">trivy-report.json</a>
    <a href="./zap-report.html" target="_blank">zap-report.html</a>
  </div>

<script>
/* ---------- helpers ---------- */
const byId = (id) => document.getElementById(id);
function getCSS(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
const colorForScore = (s) => (s >= 85 ? getCSS('--ok') : s >= 70 ? getCSS('--warn') : getCSS('--fail'));

/* ---------- load insights ---------- */
async function loadInsights() {
  const candidates = ['insights.json', './insights.json', '../insights.json'];
  for (const url of candidates) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (res.ok) return await res.json();
    } catch {}
  }
  return null;
}

/* ---------- charts ---------- */
let gaugeChart, trendChart, historyChart, riskChart;

function drawGauge(score, grade) {
  const ctx = byId('gaugeCanvas').getContext('2d');
  const fg = colorForScore(score);
  const bg = '#e5e7eb';
  if (gaugeChart) gaugeChart.destroy();

  gaugeChart = new Chart(ctx, {
    type: 'doughnut',
    data: { datasets: [{ data: [score, 100 - score], backgroundColor: [fg, bg], borderWidth: 0 }] },
    options: { cutout: '70%', rotation: -90, circumference: 180, plugins: { legend: { display: false } } }
  });
  byId('gaugeScore').textContent = `${Math.round(score)}%`;
  byId('gaugeGrade').textContent = `Grade: ${grade || '-'}`;
}

function drawTrend(history) {
  const ctx = byId('trendCanvas').getContext('2d');
  if (!Array.isArray(history) || history.length === 0) {
    byId('trendNote').textContent = 'No history yet. Run analytics to build trends.';
    return;
  }
  if (trendChart) trendChart.destroy();
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: history.map(h => new Date(h.ts).toLocaleDateString()),
      datasets: [{ label: 'Posture Score', data: history.map(h => h.score), borderColor: '#2563eb', fill: false, tension: 0.3 }]
    },
    options: { scales: { y: { min: 0, max: 100 } }, plugins: { legend: { display: false } } }
  });
}

function drawHistory(history) {
  const ctx = byId('historyChart').getContext('2d');
  if (historyChart) historyChart.destroy();
  historyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: history.map(h => new Date(h.ts).toLocaleDateString()),
      datasets: [{
        label: 'Security Posture',
        data: history.map(h => h.score),
        borderColor: '#4f46e5',
        tension: 0.3
      }]
    },
    options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
  });
}

function drawRisk(categories) {
  const ctx = byId('riskChart').getContext('2d');
  if (riskChart) riskChart.destroy();
  riskChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(categories),
      datasets: [{
        label: 'Findings',
        data: Object.values(categories),
        backgroundColor: ['#ef4444','#f59e0b','#3b82f6','#10b981']
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

/* ---------- bootstrap ---------- */
(async function init() {
  const insights = await loadInsights();
  if (!insights) {
    drawGauge(0, '-'); drawTrend([]); drawHistory([]); drawRisk({});
    byId('generatedStamp').textContent = 'Generated: — (insights.json missing)';
    return;
  }

  const ts = insights.generated || new Date().toISOString();
  const d = new Date(ts);
  byId('generatedStamp').textContent = `Generated: ${d.toISOString().replace('T', ' ').replace('Z', ' UTC')}`;

  drawGauge(insights.score || 0, insights.grade || '-');
  drawTrend(insights.history || []);
  drawHistory(insights.history || []);
  drawRisk(insights.categories || {});
})();
</script>
</body>
</html>
